name: Tests

on:
    push:
    pull_request:
    schedule:
        - cron: '0 */12 * * *'

jobs:
    test:
        runs-on: ubuntu-18.04
        if: "!contains(github.event.head_commit.message, '[ci skip]')"

        strategy:
            fail-fast: false
            matrix:
                php: [7.2, 7.3, 7.4, 8.0]
                laravel: [7.*, 8.*]
                service: ['5.7', '8']
                dependency-version: [prefer-lowest, prefer-stable]
                experimental: [false, true]

                exclude:
                    - php: 7.2
                      laravel: 8.*
                    - php: 7.2
                      experimental: true
                    - php: 7.3
                      experimental: true
                    - php: 7.4
                      experimental: true
                    - php: 8.0
                      experimental: true

                    # Do not work due to deprecated function
                    - php: 8.0
                      laravel: 7.*
                      dependency-version: prefer-lowest
                    - php: 8.0
                      laravel: 8.*
                      dependency-version: prefer-lowest



        name: 'PHP ${{ matrix.php }} / Laravel: ${{ matrix.laravel }} / ${{ matrix.dependency-version }} / MySQL ${{ matrix.service }}'

        continue-on-error: ${{ matrix.experimental }}

        env:
            COMPOSER_ARGS: ''

        steps:
            - uses: actions/checkout@master
            
            - name: Run tests
              run: ./test --php ${{ matrix.php }} --laravel ${{ matrix.laravel }} --db ${{ matrix.service }} --dependencies ${{ matrix.dependency-version }}
              continue-on-error: ${{ matrix.experimental }}
