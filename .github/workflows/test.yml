name: Tests

on:
    push:
    pull_request:
    schedule:
        - cron: '0 */12 * * *'

jobs:
    test:
        runs-on: ubuntu-latest
        if: ${{ always() && contains(needs.requirement-images.result, 'success') && !contains(github.event.head_commit.message, '[ci skip]') }}
        needs: [requirement-images]

        strategy:
            fail-fast: false
            matrix:
                php: [7.2, 7.3, 7.4, 8.0]
                laravel: [7.*, 8.*]
                service: ['5.7', '8']
                dependency-version: [prefer-lowest, prefer-stable]
                experimental: [false, true]

                exclude:
                    ## Laravel specifically not supported PHP versions
                    - php: 7.2
                      laravel: 8.*

                    # Disabled due to them not being experimental
                    - php: 7.2
                      experimental: true
                    - php: 7.3
                      experimental: true
                    - php: 7.4
                      experimental: true
                    - php: 8.0
                      experimental: true

                    # Do not work due to deprecated function
                    - php: 8.0
                      laravel: 7.*
                      dependency-version: prefer-lowest
                    - php: 8.0
                      laravel: 8.*
                      dependency-version: prefer-lowest

        name: 'PHP ${{ matrix.php }} / Laravel: ${{ matrix.laravel }} / ${{ matrix.dependency-version }} / MySQL ${{ matrix.service }}'

        continue-on-error: ${{ matrix.experimental }}

        steps:
            - uses: actions/checkout@v2

            - name: Cache Composer Downloads
              uses: actions/cache@v2
              with:
                  path: /home/runner/.cache/composer/files
                  key: ${{ runner.os }}-composer-${{ matrix.laravel }}-${{ matrix.php }}-${{ matrix.dependency-version }}-${{ github.sha }}
                  restore-keys: |
                      ${{ runner.os }}-composer-${{ matrix.laravel }}-${{ matrix.php }}-${{ matrix.dependency-version }}-
                      ${{ runner.os }}-composer-${{ matrix.laravel }}-${{ matrix.php }}-
                      ${{ runner.os }}-composer-${{ matrix.laravel }}-
                      ${{ runner.os }}-composer-

            - name: Run tests
              run: ./test --php ${{ matrix.php }} --laravel ${{ matrix.laravel }} --db ${{ matrix.service }} --dependencies ${{ matrix.dependency-version }}
              continue-on-error: ${{ matrix.experimental }}

    requirement-images:
        name: "Requirement: Building Images"
        if: ${{ always() && !contains(needs.build-php.result, 'failure') && !contains(needs.build-mysql.result, 'failure') }}

        runs-on: ubuntu-latest
        needs: [build-php, build-mysql]

        steps:
            - uses: actions/checkout@v2

    analyse:
        name: Analysing Commit
        runs-on: ubuntu-latest
        outputs:
            changed-files: ${{ steps.changed-files.outputs.files }}

        steps:
            - uses: actions/checkout@v2
              with:
                  fetch-depth: 0

            - name: Analyse Changed Files
              id: changed-files
              run: echo "::set-output name=files::$(git diff-tree --no-commit-id --name-only -r ${{ github.sha }})"

    build-php:
        runs-on: ubuntu-latest
        needs: [analyse]
        if: ${{ contains(needs.analyse.outputs.changed-files, 'Docker') || Contains(needs.analyse.outputs.changed-files, '.github') }}

        strategy:
            matrix:
                version: ['7.2', '7.3', '7.4', '8.0']
            
        name: 'Docker Image PHP Release ${{ matrix.version }}'

        steps:
            - uses: actions/checkout@v2
              with:
                  fetch-depth: 0
                  
            - name: Set up QEMU
              uses: docker/setup-qemu-action@v1

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v1

            - name: Login to DockerHub
              uses: docker/login-action@v1 
              with:
                username: ${{ secrets.DOCKERHUB_USERNAME }}
                password: ${{ secrets.DOCKERHUB_TOKEN }}

            - name: Information
              run: echo "Building Images for PHP ${{ matrix.version }}"

            - name: Build and push
              uses: docker/build-push-action@v2
              with:
                  push: true
                  context: .dev/Docker/Images/PHP
                  tags: |
                    arlonwip/php:${{ matrix.version }}
                  build-args: |
                    VERSION=${{ matrix.version }}

    build-mysql:
        runs-on: ubuntu-latest
        needs: [analyse]
        if: ${{ contains(needs.analyse.outputs.changed-files, 'Docker') || Contains(needs.analyse.outputs.changed-files, '.github') }}

        strategy:
            matrix:
                version: ['5.7', '8']
            
        name: 'Docker Image MySQL Release ${{ matrix.version }}'

        steps:
            - uses: actions/checkout@v2
              with:
                  fetch-depth: 0

            - name: Set up QEMU
              uses: docker/setup-qemu-action@v1

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v1

            - name: Login to DockerHub
              uses: docker/login-action@v1 
              with:
                username: ${{ secrets.DOCKERHUB_USERNAME }}
                password: ${{ secrets.DOCKERHUB_TOKEN }}

            - name: Information
              run: echo "Building Images for PHP ${{ matrix.version }}"

            - name: Build and push
              uses: docker/build-push-action@v2
              with:
                push: true
                context: .dev/Docker/Images/MySQL
                tags: arlonwip/mysql:${{ matrix.version }}
                build-args: |
                  VERSION=${{ matrix.version }}
